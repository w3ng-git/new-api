name: Sync Upstream

# 每天北京时间早上 9:00 (UTC 1:00) 自动同步
on:
  schedule:
    - cron: '0 1 * * *'  # 每天 UTC 1:00 执行 (北京时间 9:00)
  workflow_dispatch:  # 支持手动触发

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/Calcium-Ion/new-api.git || true
          git remote -v

      - name: Fetch upstream changes
        run: |
          git fetch upstream
          git fetch origin

      - name: Check for updates
        id: check_updates
        run: |
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)

          echo "local_commit=$LOCAL_COMMIT" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT

          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "✨ 检测到上游有新的更新"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "✅ 已经是最新版本"
          fi

      - name: Sync with upstream
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          # 尝试合并上游更新
          if git merge upstream/main --no-edit; then
            echo "✅ 成功合并上游更新"
            echo "merge_status=success" >> $GITHUB_ENV
          else
            echo "⚠️  合并时发生冲突"
            echo "merge_status=conflict" >> $GITHUB_ENV
            git merge --abort
          fi

      - name: Push changes
        if: steps.check_updates.outputs.has_updates == 'true' && env.merge_status == 'success'
        run: |
          git push origin main
          echo "✅ 已推送更新到 fork 仓库"

      - name: Create conflict issue
        if: steps.check_updates.outputs.has_updates == 'true' && env.merge_status == 'conflict'
        uses: actions/github-script@v7
        with:
          script: |
            const title = '⚠️ 上游同步失败：存在合并冲突';
            const body = `
            ## 同步上游时发生冲突

            在尝试从 [Calcium-Ion/new-api](https://github.com/Calcium-Ion/new-api) 同步最新更新时遇到合并冲突。

            ### 详细信息
            - **本地 commit**: \`${{ steps.check_updates.outputs.local_commit }}\`
            - **上游 commit**: \`${{ steps.check_updates.outputs.upstream_commit }}\`
            - **时间**: ${new Date().toISOString()}

            ### 需要手动处理
            请按照以下步骤手动解决冲突：

            \`\`\`bash
            # 1. 添加上游仓库（如果还没有）
            git remote add upstream https://github.com/Calcium-Ion/new-api.git

            # 2. 拉取上游更新
            git fetch upstream

            # 3. 合并上游 main 分支
            git merge upstream/main

            # 4. 解决冲突后提交
            git add .
            git commit -m "chore: 解决与上游的合并冲突"

            # 5. 推送到远程仓库
            git push origin main
            \`\`\`

            解决冲突后，此 issue 会自动关闭。
            `;

            // 检查是否已存在相同标题的 open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['sync-conflict']
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['sync-conflict', 'bot']
              });
              console.log('✅ 已创建冲突提醒 issue');
            } else {
              console.log('ℹ️  已存在冲突提醒 issue，跳过创建');
            }

      - name: Close resolved conflict issues
        if: steps.check_updates.outputs.has_updates == 'true' && env.merge_status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['sync-conflict']
            });

            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '✅ 冲突已解决，上游更新已成功同步。'
              });

              console.log(`✅ 已关闭 issue #${issue.number}`);
            }

      - name: Summary
        if: always()
        run: |
          echo "## 同步结果" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_updates.outputs.has_updates }}" == "true" ]; then
            if [ "${{ env.merge_status }}" == "success" ]; then
              echo "✅ **成功**: 已同步上游最新更新" >> $GITHUB_STEP_SUMMARY
              echo "- 本地 commit: \`${{ steps.check_updates.outputs.local_commit }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- 上游 commit: \`${{ steps.check_updates.outputs.upstream_commit }}\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️  **警告**: 同步失败，存在合并冲突" >> $GITHUB_STEP_SUMMARY
              echo "- 已创建 issue 提醒，请手动处理冲突" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️  **信息**: 已经是最新版本，无需同步" >> $GITHUB_STEP_SUMMARY
          fi
